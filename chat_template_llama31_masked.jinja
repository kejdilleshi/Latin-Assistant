{{- bos_token }}
{%- if not date_string is defined %}
    {%- set date_string = "26 Jul 2024" %}
{%- endif %}

{# ───── Extract first system message (optional) ───── #}
{%- if messages and messages[0]['role'] == 'system' %}
    {%- set system_message = messages[0]['content'] | trim %}
    {%- set messages = messages[1:] %}
{%- else %}
    {%- set system_message = "" %}
{%- endif %}

{# ───── Global system header ───── #}
{{- "<|start_header_id|>system<|end_header_id|>\n\n" }}
{{- "Cutting Knowledge Date: December 2023\n" }}
{{- "Today Date: " + date_string + "\n\n" }}
{{- system_message }}
{{- "<|eot_id|>" }}

{# ───── Main loop over remaining messages ───── #}
{%- for message in messages %}
    {%- set role = message['role'] %}
    {%- set content = message['content'] | trim %}

    {%- if role == 'assistant' %}
        {% generation %}
        {{- "<|start_header_id|>assistant<|end_header_id|>\n\n" }}
        {{- content }}
        {{- "<|eot_id|>" }}
        {% endgeneration %}
    {%- else %}
        {{- "<|start_header_id|>" + role + "<|end_header_id|>\n\n" }}
        {{- content }}
        {{- "<|eot_id|>" }}
    {%- endif %}
{%- endfor %}

{# ───── Final generation prompt (no mask needed here) ───── #}
{%- if add_generation_prompt %}
    {{- "<|start_header_id|>assistant<|end_header_id|>\n\n" }}
{%- endif %}
